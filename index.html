<div id="enroll-btn-container"></div>
<div id="enroll-status" style="margin-top:12px; font-size:14px; color:#555;"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
/* ================= CONFIG ================= */
const CLIENT_ID = "656751987892-s5h4b3h7aq6rl63ut7pl6hgm3d2vr46p.apps.googleusercontent.com"; 
const ENROLL_API_URL = "https://script.google.com/macros/s/AKfycbyeKrGPdEFxzq312Z4lnjYKjvhupSL2SkGos1LtzbSmO1YVWWFNpEHY29248uYN_-xHgA/exec";

/* ================= GET COURSE CODE ================= */
const params = new URLSearchParams(window.location.search);
const courseCode = params.get("course"); // LEVEL-01, LEVEL-02, etc

if (!courseCode) {
  document.getElementById("enroll-status").textContent =
    "Invalid enrollment link. No course selected.";
}

/* ================= GOOGLE SIGN-IN CALLBACK ================= */
function onEnrollGoogle(response) {
  const payload = JSON.parse(atob(response.credential.split(".")[1]));

  const email = payload.email;
  const firstName = payload.given_name || "";
  const lastName = payload.family_name || "";

  document.getElementById("enroll-status").textContent =
    `Checking enrollment for ${courseCode}...`;

  fetch(
    `${ENROLL_API_URL}` +
    `?email=${encodeURIComponent(email)}` +
    `&firstName=${encodeURIComponent(firstName)}` +
    `&lastName=${encodeURIComponent(lastName)}` +
    `&course=${encodeURIComponent(courseCode)}`
  )
    .then(r => r.json())
    .then(data => {
      if (data.records && data.records.length > 0) {
        // Already in Database → go to payment
        window.location.href =
          `https://www.kidsoday.com/payment-page?course=${encodeURIComponent(courseCode)}`;
      } else {
        // New lead → go to enrollment form
        window.location.href =
          `https://www.kidsoday.com/enroll-form?course=${encodeURIComponent(courseCode)}`;
      }
    })
    .catch(err => {
      console.error("Enroll check failed:", err);
      document.getElementById("enroll-status").textContent =
        "Failed to process enrollment. Please try again.";
    });
}

/* ================= INIT BUTTON ================= */
window.onload = () => {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: onEnrollGoogle
  });

  google.accounts.id.renderButton(
    document.getElementById("enroll-btn-container"),
    {
      theme: "outline",
      size: "large",
      text: "Enroll"
    }
  );
};
</script>
