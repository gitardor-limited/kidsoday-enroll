<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Enroll | Kids O'Day</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://checkout.flutterwave.com/v3.js"></script>

<style>
:root {
  --accent:#1a73e8;
  --bg:#f7f9fc;
  --card:#ffffff;
  --border:#e6e9ef;
  --muted:#666;
  --error:#d93025;
}

body { 
  margin:0; 
  font-family:Arial, sans-serif; 
  background:var(--bg); 
}

.container { 
  max-width:900px; 
  margin:30px auto; 
  padding:20px; 
  background:var(--card); 
  border-radius:14px; 
  border:1px solid var(--border); 
  box-shadow:0 6px 20px rgba(0,0,0,.05); 
  position:relative; 
}

h1 { 
  color:var(--accent); 
  margin-bottom:10px;
}

h3 {
  color:#333;
  font-size:20px;
  margin-bottom:20px;
}

#status { 
  font-size:14px; 
  color:var(--muted); 
  margin-bottom:20px; 
}

.course-info {
  background:#f8f9fa;
  border-left:4px solid var(--accent);
  padding:15px;
  margin-bottom:25px;
  border-radius:6px;
}

.course-info h3 {
  margin-top:0;
  margin-bottom:8px;
  color:var(--accent);
}

.course-info p {
  margin:5px 0;
  color:var(--muted);
  font-size:14px;
}

.course-info .price {
  font-size:24px;
  font-weight:bold;
  color:#333;
  margin-top:10px;
}

form input, form select { 
  display:block; 
  width:100%; 
  margin:6px 0 12px 0; 
  padding:8px; 
  border-radius:6px; 
  border:1px solid #ccc; 
  box-sizing:border-box; 
}

form input.error, form select.error { 
  border-color:var(--error); 
}

form button { 
  background:var(--accent); 
  color:#fff; 
  border:none; 
  cursor:pointer; 
  padding:12px; 
  font-size:16px;
  width:100%;
  border-radius:8px;
  font-weight:bold;
}

form button:hover { 
  opacity:0.9; 
}

form button:disabled { 
  opacity:0.6; 
  cursor:not-allowed; 
}

form label { 
  display:block; 
  margin-top:8px; 
  margin-bottom:4px; 
  font-weight:500; 
}

.form-group { 
  position:relative; 
  margin-bottom:12px; 
}

.error-message {
  color:var(--error);
  font-size:13px;
  margin-top:-8px;
  margin-bottom:12px;
  display:block;
}

#login { 
  margin-top:20px; 
}

#logout { 
  margin-top:30px; 
  font-size:13px; 
}

#logout a { 
  color:#555; 
  text-decoration:none; 
}

#logout a:hover { 
  text-decoration:underline; 
}

#countryList { 
  border:1px solid #ccc; 
  max-height:200px; 
  overflow-y:auto; 
  padding:0; 
  margin:2px 0 12px 0; 
  display:none; 
  list-style:none; 
  position:absolute; 
  background:#fff; 
  width:calc(100% - 2px);
  max-width:100%;
  z-index:1000;
  box-shadow:0 2px 8px rgba(0,0,0,0.15);
  border-radius:4px;
}

#countryList li {
  padding:8px 12px;
  cursor:pointer;
  transition:background-color 0.15s ease;
}

#countryList li:hover,
#countryList li.keyboard-selected {
  background-color:#f0f0f0;
}

@media (max-width: 600px) {
  .container { 
    margin:15px; 
    padding:15px; 
  }
  h1 { 
    font-size:24px; 
  }
  #countryList { 
    max-height:150px; 
  }
}
</style>
</head>

<body>
<div class="container">
  <h1>Confirm Enrollment Details</h1>
  <div id="status">Checking session…</div>

  <div id="login"></div>
  <div id="course-enrollment-container" style="display:none;"></div>
  <div id="form-container" style="display:none;"></div>

  <div id="logout" style="display:none;">
    <a href="#" onclick="signOut();return false;">Sign out</a>
  </div>
</div>

<script>
const CLIENT_ID = "656751987892-s5h4b3h7aq6rl63ut7pl6hgm3d2vr46p.apps.googleusercontent.com";
const API_URL = "https://script.google.com/macros/s/AKfycbyeKrGPdEFxzq312Z4lnjYKjvhupSL2SkGos1LtzbSmO1YVWWFNpEHY29248uYN_-xHgA/exec";
const SESSION_DAYS = 30;

let googleLoadRetries = 0;
const MAX_GOOGLE_RETRIES = 20;

let classCodeFromURL = null;
const urlParams = new URLSearchParams(window.location.search);
classCodeFromURL = urlParams.get('code');

if (!classCodeFromURL && window.location.hash) {
  const hashParams = new URLSearchParams(window.location.hash.substring(1));
  classCodeFromURL = hashParams.get('code');
}

function saveSession(email, firstName, lastName){ 
  localStorage.setItem("kidsoday_email", email); 
  localStorage.setItem("kidsoday_firstName", firstName || "");
  localStorage.setItem("kidsoday_lastName", lastName || "");
  localStorage.setItem("kidsoday_until", Date.now() + SESSION_DAYS*86400000); 
}

function getSession(){ 
  const e = localStorage.getItem("kidsoday_email"); 
  const u = localStorage.getItem("kidsoday_until"); 
  if(e && u && Date.now()<+u) {
    return {
      email: e,
      firstName: localStorage.getItem("kidsoday_firstName") || "",
      lastName: localStorage.getItem("kidsoday_lastName") || ""
    };
  }
  return null; 
}

function signOut(){ localStorage.clear(); location.reload(); }

function loadEnroll(email, firstName, lastName){
  const url = `${API_URL}?email=${encodeURIComponent(email)}&firstName=${encodeURIComponent(firstName || "")}&lastName=${encodeURIComponent(lastName || "")}&classCode=${encodeURIComponent(classCodeFromURL || "")}`;
  
  document.getElementById("status").textContent = "When the toys are gone, knowledge remains...";
  
  fetch(url)
    .then(r => {
      if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
      return r.json();
    })
    .then(data => {
      if(data.error) throw new Error(data.error);

      if (classCodeFromURL) {
        if (!data.inDatabase) {
          renderForm(email, firstName, lastName);
          document.getElementById("status").innerHTML = `<span style="color:var(--muted);">Please complete your profile first, then you'll be enrolled in the course.</span>`;
        } else {
          if (!data.courseData) {
            document.getElementById("status").innerHTML = `<span style="color:var(--error);">Course not found!</span>`;
            document.getElementById("logout").style.display = "block";
            return;
          }
          renderCourseEnrollment(email, data);
        }
        return;
      }
      
      if(!data.inDatabase){
        renderForm(email, firstName, lastName);
        document.getElementById("status").textContent = "Please fill the enrollment form first";
      } else {
        document.getElementById("status").innerHTML = `<span style="color:var(--muted);">Please select a course from the main page to enroll.</span>`;
        document.getElementById("logout").style.display = "block";
      }
    })
    .catch(err => { 
      document.getElementById("status").innerHTML = `<span style="color:var(--error);">Failed to load enrollment info</span><br><small style="color:var(--muted);">Error: ${err.message}</small>`; 
    });
}

function renderCourseEnrollment(email, data) {
  const container = document.getElementById("course-enrollment-container");
  container.style.display = "block";
  document.getElementById("logout").style.display = "block";
  document.getElementById("form-container").style.display = "none";

  const courseData = data.courseData || {};
  const userData = data.userData || {};
  const isAlreadyEnrolled = data.alreadyEnrolled || false;

  const courseTitle = courseData.courseTitle || "Course Not Found";
  const coursePrice = courseData.price || 0;
  const courseCurrency = courseData.currency || "$";
  const classCode = classCodeFromURL || "";

  container.innerHTML = `
    <div class="course-info">
      <h3>${courseTitle}</h3>
      <div class="price" id="displayPrice">${courseCurrency}${coursePrice.toLocaleString()}</div>
      <div style="margin-top:10px;">
        <label for="currencySelector" style="font-size:14px;color:var(--muted);">Prefer to pay in a different currency?</label>
        <select id="currencySelector" style="margin-top:5px;padding:8px;border-radius:6px;border:1px solid #ccc;width:100%;max-width:250px;">
          <option value="${courseCurrency === '₦' ? 'NGN' : courseCurrency === '£' ? 'GBP' : courseCurrency === '€' ? 'EUR' : 'USD'}" selected>
            ${courseCurrency === '₦' ? '₦ Nigerian Naira (NGN)' : 
              courseCurrency === '£' ? '£ British Pound (GBP)' : 
              courseCurrency === '€' ? '€ Euro (EUR)' : 
              '$ US Dollar (USD)'}
          </option>
          <option value="NGN">₦ Nigerian Naira (NGN)</option>
          <option value="USD">$ US Dollar (USD)</option>
          <option value="GBP">£ British Pound (GBP)</option>
          <option value="EUR">€ Euro (EUR)</option>
        </select>
        <small id="conversionNote" style="display:block;margin-top:5px;color:var(--muted);font-size:12px;">Loading exchange rates...</small>
      </div>
    </div>

    <form id="courseEnrollForm" novalidate>
      <div class="form-group">
        <label for="studentName">Full Name</label>
        <input type="text" id="studentName" name="studentName" value="${userData.fullName || ''}" readonly style="background:#f1f3f4;cursor:not-allowed;">
      </div>

      <div class="form-group">
        <label for="studentEmail">Email Address</label>
        <input type="email" id="studentEmail" name="studentEmail" value="${email}" readonly style="background:#f1f3f4;cursor:not-allowed;">
      </div>

      <div class="form-group">
        <label for="studentPhone">WhatsApp Phone Number</label>
        <input type="tel" id="studentPhone" name="studentPhone" value="${userData.whatsappNumber || ''}" readonly style="background:#f1f3f4;cursor:not-allowed;">
      </div>

      <div class="form-group">
        <label for="studentClassCode">Class Code</label>
        <input type="text" id="studentClassCode" value="${classCode}" readonly style="background:#f1f3f4;cursor:not-allowed;">
      </div>

      <button type="submit" id="payButton" ${isAlreadyEnrolled ? 'disabled' : ''}>
        ${isAlreadyEnrolled ? 'Already Enrolled' : 'Proceed to Payment'}
      </button>
    </form>
  `;

  if (!isAlreadyEnrolled) {
    const form = document.getElementById('courseEnrollForm');
    const payButton = document.getElementById('payButton');
    const currencySelector = document.getElementById('currencySelector');
    const displayPrice = document.getElementById('displayPrice');
    const conversionNote = document.getElementById('conversionNote');
    
    const originalCurrency = courseCurrency === "₦" ? "NGN" : 
                            courseCurrency === "$" ? "USD" : 
                            courseCurrency === "£" ? "GBP" : 
                            courseCurrency === "€" ? "EUR" : "USD";
    const originalPrice = coursePrice;
    
    const currencySymbols = {
      'NGN': '₦',
      'USD': '$',
      'GBP': '£',
      'EUR': '€'
    };
    
    let currentPrice = originalPrice;
    let currentCurrency = originalCurrency;
    let exchangeRates = {};
    
    async function fetchExchangeRates() {
      try {
        conversionNote.textContent = "Loading exchange rates...";
        const response = await fetch(`https://api.exchangerate-api.com/v4/latest/${originalCurrency}`);
        const data = await response.json();
        
        if (data && data.rates) {
          exchangeRates = data.rates;
          conversionNote.textContent = `Exchange rates updated: ${new Date().toLocaleTimeString()}`;
          updatePrice();
        } else {
          throw new Error("Invalid response");
        }
      } catch (error) {
        console.error("Exchange rate fetch error:", error);
        conversionNote.textContent = "Unable to load exchange rates. Showing original price.";
        conversionNote.style.color = "var(--error)";
      }
    }
    
    function updatePrice() {
      const selectedCurrency = currencySelector.value;
      
      if (selectedCurrency === originalCurrency) {
        currentPrice = originalPrice;
        currentCurrency = originalCurrency;
        displayPrice.textContent = `${currencySymbols[originalCurrency]}${originalPrice.toLocaleString()}`;
        conversionNote.textContent = "Original course price";
        conversionNote.style.color = "var(--muted)";
      } else if (exchangeRates[selectedCurrency]) {
        const rate = exchangeRates[selectedCurrency];
        currentPrice = Math.ceil(originalPrice * rate);
        currentCurrency = selectedCurrency;
        
        displayPrice.textContent = `${currencySymbols[selectedCurrency]}${currentPrice.toLocaleString()}`;
        conversionNote.innerHTML = `Converted from ${currencySymbols[originalCurrency]}${originalPrice.toLocaleString()} ${originalCurrency}<br>
                                    <small>Rate: 1 ${originalCurrency} = ${rate.toFixed(4)} ${selectedCurrency}</small>`;
        conversionNote.style.color = "var(--muted)";
      } else {
        conversionNote.textContent = "Exchange rate not available for this currency";
        conversionNote.style.color = "var(--error)";
      }
    }
    
    currencySelector.addEventListener('change', updatePrice);
    fetchExchangeRates();

    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      payButton.disabled = true;
      payButton.textContent = "Processing...";

      FlutterwaveCheckout({
        public_key: "FLWPUBK-94d902aff72af3143763e961a5d612f0-X",
        tx_ref: "TX_REF_" + Date.now(),
        amount: currentPrice,
        currency: currentCurrency,
        payment_options: "card, mobilemoney, ussd",
        customer: {
          name: userData.fullName || "",
          email: email,
          phone_number: userData.whatsappNumber || ""
        },
        meta: {
          course: courseTitle,
          class_code: classCode,
          original_price: originalPrice,
          original_currency: originalCurrency,
          selected_currency: currentCurrency,
          conversion_rate: currentCurrency !== originalCurrency ? exchangeRates[currentCurrency] : 1
        },
        callback: function (data) {
          window.location.href = "https://www.kidsoday.com/enroll/payment-success";
        },
        onclose: function() {
          payButton.disabled = false;
          payButton.textContent = "Proceed to Payment";
        },
      });
    });
  } else {
    document.getElementById("status").textContent = "You are already enrolled in this course";
  }
}

function renderForm(email, firstName, lastName){
  // ... (keeping the rest of your renderForm function - it's too long to include here but remains unchanged)
}

function onGoogle(res){
  const payload = JSON.parse(atob(res.credential.split(".")[1]));
  const email = payload.email;
  const firstName = payload.given_name || "";
  const lastName = payload.family_name || "";
  
  saveSession(email, firstName, lastName);
  document.getElementById("login").style.display="none";
  loadEnroll(email, firstName, lastName);
}

function initializeGoogleSignIn() {
  const sessionData = getSession();
  
  if (typeof google !== 'undefined' && google.accounts) {
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogle });

    if(sessionData){ 
      document.getElementById("login").style.display="none"; 
      loadEnroll(sessionData.email, sessionData.firstName, sessionData.lastName); 
    }
    else {
      document.getElementById("status").textContent="Sign in to enroll";
      google.accounts.id.renderButton(document.getElementById("login"), { theme:"outline", size:"large" });
    }
  } else {
    if (googleLoadRetries < MAX_GOOGLE_RETRIES) {
      googleLoadRetries++;
      document.getElementById("status").textContent="Loading Google Sign-In...";
      setTimeout(initializeGoogleSignIn, 100);
    } else {
      document.getElementById("status").textContent="Failed to load Google Sign-In. Please refresh the page.";
    }
  }
}

window.onload = initializeGoogleSignIn;
</script>

</body>
</html>
